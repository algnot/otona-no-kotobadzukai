<% numberWithCommas=function(x) { x=parseFloat(x).toFixed(2); return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","
    ); }; getDateFormated=function(date) { var d=new Date(date); var month=d.getMonth() + 1; var day=d.getDate(); var
    year=d.getFullYear(); return day + "/" + month + "/" + year; }; %>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300&display=swap');

        :root {
            --font-color: black;
            --highlight-color: #d66100;
            --footer-bg-color: #BFC0C3;
            --table-row-separator-color: #BFC0C3;
        }

        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        hr {
            height: 0;
            border: 0;
            border-top: 1mm solid var(--highlight-color);
        }

        header {
            height: 8cm;
            /* padding: 0 2cm; */
            position: running(header);
            background-color: var(--header-bg-color);
        }

        /*
    For the different sections in the header we use some flexbox and keep space between
    with the justify-content property.
    */
        header .headerSection {
            display: flex;
            justify-content: space-between;
        }

        /*
    To move the first sections a little down and have more space between the top of 
    the document and the logo/company name we give the section a padding top of 5mm.
    */
        header .headerSection:first-child {
            padding-top: .5cm;
        }

        /*
    Similar we keep some space at the bottom of the header with the padding-bottom
    property.
    */
        header .headerSection:last-child {
            padding-bottom: .5cm;
        }

        /*
    Within the header sections we have defined two DIV elements, and the last one in
    each headerSection element should only take 35% of the headers width.
    */
        header .headerSection div:last-child {
            width: 35%;
        }

        /*
    The SVG gets set to a fixed size and get 5mm margin right to keep some distance
    to the company name.
    */
        header .logoAndName svg {
            width: 1.5cm;
            height: 1.5cm;
            margin-right: .5cm;
        }

        /*
    To ensure the top right section "Invoice #100" starts on the same level as the Logo &
    Name we set a padding top of 1cm for this element.
    */
        header .headerSection .invoiceDetails {
            padding-top: .5cm;
        }

        /*
    The H3 element "ISSUED TO" gets another 25mm margin to the right to keep some 
    space between this header and the client's address.
    Additionally this header text gets the hightlight color as font color.
    */
        header .headerSection h3 {
            /* margin: 0 .75cm 0 0; */
            color: var(--highlight-color);
        }

        /*
    Put some margin between the "DUE DATE" and "AMOUNT" headings.
    */
        header .headerSection div:last-of-type h3:last-of-type {
            margin-top: .5cm;
        }

        /*
    The paragraphs within the header sections DIV elements get a small 2px margin top
    to ensure its in line with the "ISSUED TO" header text.
    */
        header .headerSection div p {
            margin-top: 2px;
        }

        /*
    All header elements and paragraphs within the HTML HEADER tag get a margin of 0.
    */
        header h1,
        header h2,
        header h3,
        header p {
            margin: 0;
        }

        /*
    The invoice details should not be uppercase and also be aligned to the right.
    */
        header .invoiceDetails,
        header .invoiceDetails h2 {
            text-align: right;
            font-size: 1em;
            text-transform: none;
        }

        /*
    Heading of level 2 and 3 ("DUE DATE", "AMOUNT" and "INVOICE TO") need to be written in 
    uppercase, so we use the text-transform property for that.
    */
        header h2,
        header h3 {
            text-transform: uppercase;
        }

        /*
    Our main content is all within the HTML MAIN element. In this template this are
    two tables. The one which lists all items and the table which shows us the 
    subtotal, tax and total amount.
    
    Both tables get the full width and collapse the border.
    */
        main table {
            width: calc(100% - 1cm);
            border-collapse: collapse;
            margin: 0 auto;
        }

        /*
    We put the first tables headers in a THEAD element, this way they repeat on the
    next page if our table overflows to multiple pages.
    
    The text color gets set to the highlight color.
    */
        main table thead th {
            height: 1cm;
            color: var(--highlight-color);
        }

        /*
    For the last three columns we set a fixed width of 2.5cm, so if we would change
    the documents size only the first column with the item name and description grows.
    */
        main table thead th:nth-of-type(2),
        main table thead th:nth-of-type(3),
        main table thead th:nth-of-type(4) {
            width: 3cm;
        }

        /*
    The items itself are all with the TBODY element, each cell gets a padding top
    and bottom of 2mm.
    */
        main table tbody td {
            padding: 2mm 0;
        }

        /*
    The cells in the last column (in this template the column containing the total)
    get a text align right so the text is at the end of the table.
    */
        main table thead th:last-of-type,
        main table tbody td:last-of-type {
            text-align: right;
        }

        /*
    By default text within TH elements is aligned in the center, we do not want that
    so we overwrite it with an left alignment.
    */
        main table th {
            text-align: left;
        }

        /*
    The summary table, so the table containing the subtotal, tax and total amount 
    gets a width of 40% + 2cm. The plus 2cm is added because our body has a 2cm padding
    but we want our highlight color for the total row to go to the edge of the document.
    
    To move the table to the right side we simply set a margin-left of 60%.
    */
        main table.summary {
            width: calc(40% + 2cm);
            margin-left: 60%;
            margin-top: .5cm;
        }

        /*
    The row containing the total amount gets its background color set to the highlight 
    color and the font weight to bold.
    */
        main table.summary tr.total {
            font-weight: bold;
            background-color: var(--highlight-color);
        }

        /*
    The TH elements of the summary table are not on top but the cells on the left side
    these get a padding left of 1cm to give the highlight color some space.
    */
        main table.summary th {
            padding: 4mm 0 4mm 1cm;
        }

        /*
    As only the highlight background color should go to the edge of the document
    but the text should still have the 2cm distance, we set the padding right to 
    2cm.
    */
        main table.summary td {
            /* padding: 4mm 2cm 2mm 0; */
            border-bottom: 0;
        }

        /*
    The content below the tables is placed in a ASIDE element next to the MAIN element.
    To ensure this element is always at the bottom of the page, just above the page 
    footer, we use the Prince custom property "-prince-float" with the value bottom.

        /*
    The page footer in our document uses the HTML FOOTER element, we define a height 
    of 3cm matching the margin bottom of the page (see @page rule) and a padding left
    and right of 2cm. We did not give the page itself a margin of 2cm to ensure that
    the background color goes to the edges of the document.
    
    As mentioned above in the comment for the @page the position property with the 
    value running(footer) makes this HTML element float into the bottom left page margin
    box. This page margin box repeats on every page in case we would have a multi-page
    invoice.
    
    The content inside the footer is aligned with the help of line-height 3cm and a 
    flexbox for the child elements.
    */
        footer {
            height: 3cm;
            line-height: 3cm;
            padding: 0 2cm;
            position: running(footer);
            background-color: var(--footer-bg-color);
            font-size: 8pt;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }

        /*
    The first link in the footer, which points to the company website is highlighted 
    in bold.
    */
        footer a:first-child {
            font-weight: bold;
        }
    </style>
    <!-- The header element will appear on the top of each page of this invoice document. -->
    <header>
        <div class="headerSection" style="padding: 0.25cm 1cm;">
            <div class="logoAndName">
                <h1>
                    Invoice
                </h1>
                <div>
                    <%= name %>
                </div>
            </div>
            <!-- Details about the invoice are on the right top side of each page. -->
            <div class="invoiceDetails">
                <h2>Ref: <%= ref %>
                </h2>
                <p>
                    วันที่ออก invoice <%= getDateFormated(createdAt) %>
                </p>
            </div>
        </div>
        <!-- The two header rows are divided by an blue line, we use the HR element for this. -->
        <hr />
        <div class="headerSection" style="margin: 0.5cm 1cm;">
            <!-- The clients details come on the left side below the logo and company name. -->
            <div>
                <h3>จาก</h3>
                <p style="margin-bottom: 0.5cm;">
                    <span><b>
                            <%= owner.name %>
                        </b> (<%= owner.email %>)</span>
                </p>
                <h3>ถึง</h3>
                <p>
                    <span><b>
                            <%= userBill[0].name %>
                        </b> (<%= userBill[0].email %>)</span>
                </p>
            </div>
            <!-- Additional details can be placed below the invoice details. -->
            <div>
                <h3>สถานะ</h3>
                <p>
                    <b>
                        <%= state %>
                    </b>
                </p>
                <h3>ยอดที่ต้องชำระ</h3>
                <p>
                    <b>฿ <%= numberWithCommas(totalAmount) %></b>
                </p>
            </div>
        </div>
    </header>

    <!-- In the main section the table for the separate items is added. Also we add another table for the summary, so subtotal, tax and total amount. -->
    <main>
        <table>
            <!-- A THEAD element is used to ensure the header of the table is repeated if it consumes more than one page. -->
            <thead>
                <tr>
                    <th>รายการ</th>
                    <th>ราคา</th>
                    <th>จำนวน</th>
                    <th>รวม</th>
                </tr>
            </thead>
            <!-- The single invoice items are all within the TBODY of the table. -->
            <tbody>
                <!-- loop in ejs -->
                <% for (let i=0; i < billItem.length; i++) { %>
                    <tr>
                        <td>
                            <b>
                                <%= billItem[i].name %>
                            </b>
                        </td>
                        <td>
                            <%= numberWithCommas(billItem[i].unitAmount) %>
                        </td>
                        <td>
                            <%= billItem[i].quantity %>
                        </td>
                        <td>
                            <%= numberWithCommas(billItem[i].amount) %>
                        </td>
                    </tr>
                    <% } %>
            </tbody>
        </table>
    </main>
    <div style="display: grid; grid-template-columns: 7cm 5cm; text-align: right; row-gap: .25cm; justify-content: flex-end; margin: 1cm .5cm;">
        <b>ราคารวม</b>
        <div><%= numberWithCommas(amount) %> ฿</div>

        <b>ภาษี (<%= billItem[0].taxPercent %>%)</b>
        <div><%= numberWithCommas(totalTax) %> ฿</div>

        <b>Service Charge (<%= billItem[0].serviceChargePercent %>%)</b>
        <div><%= numberWithCommas(totalServiceCharge) %> ฿</div>

        <b style="font-size: 21px;">รวม</b>
        <b style="font-size: 21px;"><%= numberWithCommas(totalAmount) %> ฿</b>
    </div>
    <!-- Within the aside tag we will put the terms and conditions which shall be shown below the invoice table. -->
    <aside style="display: fixed; bottom: 0;">
        <!-- Before the terms and conditions we will add another blue divider line with the help of the HR tag. -->
        <hr />
        <div style="margin: 1cm .5cm;">
            <div>
                <b>ข้อกำหนดและเงื่อนไข</b>
                <p style="text-align: justify;">
                    &nbsp; &nbsp; ท่านสามารถติดตามสถานะของ invoice ได้ <b><a href="<%= context.frontend_path %>/bill/<%= ref %>" target="_blank">ที่นี่</a></b>
                    หากมีข้อสงสัยเกี่ยวกับสถานะของ invoice โปรดติดต่อที่ <b><a href="mailto:<%= owner.email %>" target="_blank"><%= owner.email %></a></b>
                    ในกรณีที่ท่านทำการชำระแล้วโปรดแนบหลักฐานการชำระที่ <b><a href="<%= context.frontend_path %>/bill/<%= ref %>" target="_blank">ที่นี่</a></b>
                    และทำการกดปุ่ม ยืนยันการชำระเงิน และรอ <%= owner.name %></b> ทำการยืนยันการชำระเงินดังกล่าว
                </p>
            </div>
            <div>
                <b>การชำระเงิน</b>
                <p style="text-align: justify;">
                    &nbsp; &nbsp; ท่านสามารถทำการชำระเงินได้ที่พร้อมเพย์บัญชี <b><%= payment[0].name %></b>  
                    เลขที่พร้อมเพย์ <b><%= payment[0].number %></b> หรือสแกน QR Code ด้านล่าง          
                </p>
                <div>
                    <img alt="payment" src="<%= context.promptpay_api_url %>/api?id=<%= payment[0].number %>&amount=<%= payment[0].totalAmount %>" style="width: 150px; height: 150px;">
                </div>
            </div>
        </div>
    </aside>